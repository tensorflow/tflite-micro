/* Copyright 2023 The TensorFlow Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
==============================================================================*/

#include <stddef.h>
#include <stdint.h>
#include <xtensa/config/core-isa.h>

#if XCHAL_HAVE_HIFI3 || XCHAL_HAVE_HIFI4 || XCHAL_HAVE_HIFI5
#include <NatureDSP_Signal.h>
#else
#include "signal/src/kiss_fft_wrappers/kiss_fft_int16.h"
#endif
#include "signal/src/complex.h"
#include "signal/src/rfft.h"

namespace tflm_signal {

#if !defined MIN_RFFT_LEN
#define MIN_RFFT_LEN 32
#endif
#if !defined MAX_RFFT_LEN
#define MAX_RFFT_LEN 8192
#endif

#if XCHAL_HAVE_HIFI3 || XCHAL_HAVE_HIFI4 || XCHAL_HAVE_HIFI5
struct RfftState {
#if defined XTENSA_NDSP_FFT_MEM_OPTIMIZED
  int32_t fft_length;
  int32_t fft_length_log2;
  int32_t output_length;
#endif
  fft_handle_t handle;
};
#else
// Using KissFFT. No need for state.
#endif

#if XTENSA_NDSP_FFT_MEM_OPTIMIZED

// The Nature DSP library has a memory optimized implementation if FFT that
// uses ~18KB less code than the fully-featured FFT implementation. However, it
// is limited to FFT of sizes 256, 512, 1024 and only supports dynamic scaling
// with right shifts. It also take a twiddle table as an input.
// The twiddle tables are in a highly unusual format, which isn't documented.
// Instead of trying to figure out the close form for the table, the actual
// arrays were copied from the library's test vectors:
// fft_cplx32x16_ie_twd_256.bin
// fft_cplx32x16_ie_twd_512.bin
// fft_cplx32x16_ie_twd_1024.bin
// located under NDSP_HiFi3_v410/testdriver/vectors_sanity/fft_twd
// The vectors were converted from fp64 to int16 by multiplying each element
// by 32767 and limiting the value to [-32768,32767]. This is the same
// conversion done in Nature DSP's test engine.

#if MIN_RFFT_LEN <= 256 && MAX_RFFT_LEN >= 256
const complex_fract16 twiddles_256[] = {
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -804, .im = 32757}},
    {.s = {.re = -1608, .im = 32728}},   {.s = {.re = -2410, .im = 32678}},
    {.s = {.re = -3212, .im = 32609}},   {.s = {.re = -4011, .im = 32521}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -5602, .im = 32285}},
    {.s = {.re = -6393, .im = 32137}},   {.s = {.re = -7179, .im = 31971}},
    {.s = {.re = -7962, .im = 31785}},   {.s = {.re = -8739, .im = 31580}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -10278, .im = 31113}},
    {.s = {.re = -11039, .im = 30852}},  {.s = {.re = -11793, .im = 30571}},
    {.s = {.re = -12539, .im = 30273}},  {.s = {.re = -13279, .im = 29956}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -14732, .im = 29268}},
    {.s = {.re = -15446, .im = 28898}},  {.s = {.re = -16151, .im = 28510}},
    {.s = {.re = -16846, .im = 28105}},  {.s = {.re = -17530, .im = 27683}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -18868, .im = 26790}},
    {.s = {.re = -19519, .im = 26319}},  {.s = {.re = -20159, .im = 25832}},
    {.s = {.re = -20787, .im = 25329}},  {.s = {.re = -21403, .im = 24811}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -22594, .im = 23731}},
    {.s = {.re = -23170, .im = 23170}},  {.s = {.re = -23731, .im = 22594}},
    {.s = {.re = -24279, .im = 22005}},  {.s = {.re = -24811, .im = 21403}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -25832, .im = 20159}},
    {.s = {.re = -26319, .im = 19519}},  {.s = {.re = -26790, .im = 18868}},
    {.s = {.re = -27245, .im = 18204}},  {.s = {.re = -27683, .im = 17530}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -28510, .im = 16151}},
    {.s = {.re = -28898, .im = 15446}},  {.s = {.re = -29268, .im = 14732}},
    {.s = {.re = -29621, .im = 14010}},  {.s = {.re = -29956, .im = 13279}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30571, .im = 11793}},
    {.s = {.re = -30852, .im = 11039}},  {.s = {.re = -31113, .im = 10278}},
    {.s = {.re = -31356, .im = 9512}},   {.s = {.re = -31580, .im = 8739}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -31971, .im = 7179}},
    {.s = {.re = -32137, .im = 6393}},   {.s = {.re = -32285, .im = 5602}},
    {.s = {.re = -32412, .im = 4808}},   {.s = {.re = -32521, .im = 4011}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32678, .im = 2410}},
    {.s = {.re = -32728, .im = 1608}},   {.s = {.re = -32757, .im = 804}},
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -1608, .im = 32728}},
    {.s = {.re = -3212, .im = 32609}},   {.s = {.re = -4808, .im = 32412}},
    {.s = {.re = -6393, .im = 32137}},   {.s = {.re = -7962, .im = 31785}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -11039, .im = 30852}},
    {.s = {.re = -12539, .im = 30273}},  {.s = {.re = -14010, .im = 29621}},
    {.s = {.re = -15446, .im = 28898}},  {.s = {.re = -16846, .im = 28105}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -19519, .im = 26319}},
    {.s = {.re = -20787, .im = 25329}},  {.s = {.re = -22005, .im = 24279}},
    {.s = {.re = -23170, .im = 23170}},  {.s = {.re = -24279, .im = 22005}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -26319, .im = 19519}},
    {.s = {.re = -27245, .im = 18204}},  {.s = {.re = -28105, .im = 16846}},
    {.s = {.re = -28898, .im = 15446}},  {.s = {.re = -29621, .im = 14010}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30852, .im = 11039}},
    {.s = {.re = -31356, .im = 9512}},   {.s = {.re = -31785, .im = 7962}},
    {.s = {.re = -32137, .im = 6393}},   {.s = {.re = -32412, .im = 4808}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32728, .im = 1608}},
    {.s = {.re = -32767, .im = 0}},      {.s = {.re = -32728, .im = -1608}},
    {.s = {.re = -32609, .im = -3212}},  {.s = {.re = -32412, .im = -4808}},
    {.s = {.re = -32137, .im = -6393}},  {.s = {.re = -31785, .im = -7962}},
    {.s = {.re = -31356, .im = -9512}},  {.s = {.re = -30852, .im = -11039}},
    {.s = {.re = -30273, .im = -12539}}, {.s = {.re = -29621, .im = -14010}},
    {.s = {.re = -28898, .im = -15446}}, {.s = {.re = -28105, .im = -16846}},
    {.s = {.re = -27245, .im = -18204}}, {.s = {.re = -26319, .im = -19519}},
    {.s = {.re = -25329, .im = -20787}}, {.s = {.re = -24279, .im = -22005}},
    {.s = {.re = -23170, .im = -23170}}, {.s = {.re = -22005, .im = -24279}},
    {.s = {.re = -20787, .im = -25329}}, {.s = {.re = -19519, .im = -26319}},
    {.s = {.re = -18204, .im = -27245}}, {.s = {.re = -16846, .im = -28105}},
    {.s = {.re = -15446, .im = -28898}}, {.s = {.re = -14010, .im = -29621}},
    {.s = {.re = -12539, .im = -30273}}, {.s = {.re = -11039, .im = -30852}},
    {.s = {.re = -9512, .im = -31356}},  {.s = {.re = -7962, .im = -31785}},
    {.s = {.re = -6393, .im = -32137}},  {.s = {.re = -4808, .im = -32412}},
    {.s = {.re = -3212, .im = -32609}},  {.s = {.re = -1608, .im = -32728}},
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -2410, .im = 32678}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -7179, .im = 31971}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -11793, .im = 30571}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -16151, .im = 28510}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -20159, .im = 25832}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -23731, .im = 22594}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -26790, .im = 18868}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -29268, .im = 14732}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -31113, .im = 10278}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -32285, .im = 5602}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32757, .im = 804}},
    {.s = {.re = -32728, .im = -1608}},  {.s = {.re = -32521, .im = -4011}},
    {.s = {.re = -32137, .im = -6393}},  {.s = {.re = -31580, .im = -8739}},
    {.s = {.re = -30852, .im = -11039}}, {.s = {.re = -29956, .im = -13279}},
    {.s = {.re = -28898, .im = -15446}}, {.s = {.re = -27683, .im = -17530}},
    {.s = {.re = -26319, .im = -19519}}, {.s = {.re = -24811, .im = -21403}},
    {.s = {.re = -23170, .im = -23170}}, {.s = {.re = -21403, .im = -24811}},
    {.s = {.re = -19519, .im = -26319}}, {.s = {.re = -17530, .im = -27683}},
    {.s = {.re = -15446, .im = -28898}}, {.s = {.re = -13279, .im = -29956}},
    {.s = {.re = -11039, .im = -30852}}, {.s = {.re = -8739, .im = -31580}},
    {.s = {.re = -6393, .im = -32137}},  {.s = {.re = -4011, .im = -32521}},
    {.s = {.re = -1608, .im = -32728}},  {.s = {.re = 804, .im = -32757}},
    {.s = {.re = 3212, .im = -32609}},   {.s = {.re = 5602, .im = -32285}},
    {.s = {.re = 7962, .im = -31785}},   {.s = {.re = 10278, .im = -31113}},
    {.s = {.re = 12539, .im = -30273}},  {.s = {.re = 14732, .im = -29268}},
    {.s = {.re = 16846, .im = -28105}},  {.s = {.re = 18868, .im = -26790}},
    {.s = {.re = 20787, .im = -25329}},  {.s = {.re = 22594, .im = -23731}},
    {.s = {.re = 24279, .im = -22005}},  {.s = {.re = 25832, .im = -20159}},
    {.s = {.re = 27245, .im = -18204}},  {.s = {.re = 28510, .im = -16151}},
    {.s = {.re = 29621, .im = -14010}},  {.s = {.re = 30571, .im = -11793}},
    {.s = {.re = 31356, .im = -9512}},   {.s = {.re = 31971, .im = -7179}},
    {.s = {.re = 32412, .im = -4808}},   {.s = {.re = 32678, .im = -2410}},
};
#endif

#if MIN_RFFT_LEN <= 512 && MAX_RFFT_LEN >= 512
const complex_fract16 twiddles_512[] = {
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -402, .im = 32765}},
    {.s = {.re = -804, .im = 32757}},    {.s = {.re = -1206, .im = 32745}},
    {.s = {.re = -1608, .im = 32728}},   {.s = {.re = -2009, .im = 32705}},
    {.s = {.re = -2410, .im = 32678}},   {.s = {.re = -2811, .im = 32646}},
    {.s = {.re = -3212, .im = 32609}},   {.s = {.re = -3612, .im = 32567}},
    {.s = {.re = -4011, .im = 32521}},   {.s = {.re = -4410, .im = 32469}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -5205, .im = 32351}},
    {.s = {.re = -5602, .im = 32285}},   {.s = {.re = -5998, .im = 32213}},
    {.s = {.re = -6393, .im = 32137}},   {.s = {.re = -6786, .im = 32057}},
    {.s = {.re = -7179, .im = 31971}},   {.s = {.re = -7571, .im = 31880}},
    {.s = {.re = -7962, .im = 31785}},   {.s = {.re = -8351, .im = 31685}},
    {.s = {.re = -8739, .im = 31580}},   {.s = {.re = -9126, .im = 31470}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -9896, .im = 31237}},
    {.s = {.re = -10278, .im = 31113}},  {.s = {.re = -10659, .im = 30985}},
    {.s = {.re = -11039, .im = 30852}},  {.s = {.re = -11417, .im = 30714}},
    {.s = {.re = -11793, .im = 30571}},  {.s = {.re = -12167, .im = 30424}},
    {.s = {.re = -12539, .im = 30273}},  {.s = {.re = -12910, .im = 30117}},
    {.s = {.re = -13279, .im = 29956}},  {.s = {.re = -13645, .im = 29791}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -14372, .im = 29447}},
    {.s = {.re = -14732, .im = 29268}},  {.s = {.re = -15090, .im = 29085}},
    {.s = {.re = -15446, .im = 28898}},  {.s = {.re = -15800, .im = 28706}},
    {.s = {.re = -16151, .im = 28510}},  {.s = {.re = -16499, .im = 28310}},
    {.s = {.re = -16846, .im = 28105}},  {.s = {.re = -17189, .im = 27896}},
    {.s = {.re = -17530, .im = 27683}},  {.s = {.re = -17869, .im = 27466}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -18537, .im = 27019}},
    {.s = {.re = -18868, .im = 26790}},  {.s = {.re = -19195, .im = 26556}},
    {.s = {.re = -19519, .im = 26319}},  {.s = {.re = -19841, .im = 26077}},
    {.s = {.re = -20159, .im = 25832}},  {.s = {.re = -20475, .im = 25582}},
    {.s = {.re = -20787, .im = 25329}},  {.s = {.re = -21096, .im = 25072}},
    {.s = {.re = -21403, .im = 24811}},  {.s = {.re = -21705, .im = 24547}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -22301, .im = 24007}},
    {.s = {.re = -22594, .im = 23731}},  {.s = {.re = -22884, .im = 23452}},
    {.s = {.re = -23170, .im = 23170}},  {.s = {.re = -23452, .im = 22884}},
    {.s = {.re = -23731, .im = 22594}},  {.s = {.re = -24007, .im = 22301}},
    {.s = {.re = -24279, .im = 22005}},  {.s = {.re = -24547, .im = 21705}},
    {.s = {.re = -24811, .im = 21403}},  {.s = {.re = -25072, .im = 21096}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -25582, .im = 20475}},
    {.s = {.re = -25832, .im = 20159}},  {.s = {.re = -26077, .im = 19841}},
    {.s = {.re = -26319, .im = 19519}},  {.s = {.re = -26556, .im = 19195}},
    {.s = {.re = -26790, .im = 18868}},  {.s = {.re = -27019, .im = 18537}},
    {.s = {.re = -27245, .im = 18204}},  {.s = {.re = -27466, .im = 17869}},
    {.s = {.re = -27683, .im = 17530}},  {.s = {.re = -27896, .im = 17189}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -28310, .im = 16499}},
    {.s = {.re = -28510, .im = 16151}},  {.s = {.re = -28706, .im = 15800}},
    {.s = {.re = -28898, .im = 15446}},  {.s = {.re = -29085, .im = 15090}},
    {.s = {.re = -29268, .im = 14732}},  {.s = {.re = -29447, .im = 14372}},
    {.s = {.re = -29621, .im = 14010}},  {.s = {.re = -29791, .im = 13645}},
    {.s = {.re = -29956, .im = 13279}},  {.s = {.re = -30117, .im = 12910}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30424, .im = 12167}},
    {.s = {.re = -30571, .im = 11793}},  {.s = {.re = -30714, .im = 11417}},
    {.s = {.re = -30852, .im = 11039}},  {.s = {.re = -30985, .im = 10659}},
    {.s = {.re = -31113, .im = 10278}},  {.s = {.re = -31237, .im = 9896}},
    {.s = {.re = -31356, .im = 9512}},   {.s = {.re = -31470, .im = 9126}},
    {.s = {.re = -31580, .im = 8739}},   {.s = {.re = -31685, .im = 8351}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -31880, .im = 7571}},
    {.s = {.re = -31971, .im = 7179}},   {.s = {.re = -32057, .im = 6786}},
    {.s = {.re = -32137, .im = 6393}},   {.s = {.re = -32213, .im = 5998}},
    {.s = {.re = -32285, .im = 5602}},   {.s = {.re = -32351, .im = 5205}},
    {.s = {.re = -32412, .im = 4808}},   {.s = {.re = -32469, .im = 4410}},
    {.s = {.re = -32521, .im = 4011}},   {.s = {.re = -32567, .im = 3612}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32646, .im = 2811}},
    {.s = {.re = -32678, .im = 2410}},   {.s = {.re = -32705, .im = 2009}},
    {.s = {.re = -32728, .im = 1608}},   {.s = {.re = -32745, .im = 1206}},
    {.s = {.re = -32757, .im = 804}},    {.s = {.re = -32765, .im = 402}},
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -804, .im = 32757}},
    {.s = {.re = -1608, .im = 32728}},   {.s = {.re = -2410, .im = 32678}},
    {.s = {.re = -3212, .im = 32609}},   {.s = {.re = -4011, .im = 32521}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -5602, .im = 32285}},
    {.s = {.re = -6393, .im = 32137}},   {.s = {.re = -7179, .im = 31971}},
    {.s = {.re = -7962, .im = 31785}},   {.s = {.re = -8739, .im = 31580}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -10278, .im = 31113}},
    {.s = {.re = -11039, .im = 30852}},  {.s = {.re = -11793, .im = 30571}},
    {.s = {.re = -12539, .im = 30273}},  {.s = {.re = -13279, .im = 29956}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -14732, .im = 29268}},
    {.s = {.re = -15446, .im = 28898}},  {.s = {.re = -16151, .im = 28510}},
    {.s = {.re = -16846, .im = 28105}},  {.s = {.re = -17530, .im = 27683}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -18868, .im = 26790}},
    {.s = {.re = -19519, .im = 26319}},  {.s = {.re = -20159, .im = 25832}},
    {.s = {.re = -20787, .im = 25329}},  {.s = {.re = -21403, .im = 24811}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -22594, .im = 23731}},
    {.s = {.re = -23170, .im = 23170}},  {.s = {.re = -23731, .im = 22594}},
    {.s = {.re = -24279, .im = 22005}},  {.s = {.re = -24811, .im = 21403}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -25832, .im = 20159}},
    {.s = {.re = -26319, .im = 19519}},  {.s = {.re = -26790, .im = 18868}},
    {.s = {.re = -27245, .im = 18204}},  {.s = {.re = -27683, .im = 17530}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -28510, .im = 16151}},
    {.s = {.re = -28898, .im = 15446}},  {.s = {.re = -29268, .im = 14732}},
    {.s = {.re = -29621, .im = 14010}},  {.s = {.re = -29956, .im = 13279}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30571, .im = 11793}},
    {.s = {.re = -30852, .im = 11039}},  {.s = {.re = -31113, .im = 10278}},
    {.s = {.re = -31356, .im = 9512}},   {.s = {.re = -31580, .im = 8739}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -31971, .im = 7179}},
    {.s = {.re = -32137, .im = 6393}},   {.s = {.re = -32285, .im = 5602}},
    {.s = {.re = -32412, .im = 4808}},   {.s = {.re = -32521, .im = 4011}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32678, .im = 2410}},
    {.s = {.re = -32728, .im = 1608}},   {.s = {.re = -32757, .im = 804}},
    {.s = {.re = -32767, .im = 0}},      {.s = {.re = -32757, .im = -804}},
    {.s = {.re = -32728, .im = -1608}},  {.s = {.re = -32678, .im = -2410}},
    {.s = {.re = -32609, .im = -3212}},  {.s = {.re = -32521, .im = -4011}},
    {.s = {.re = -32412, .im = -4808}},  {.s = {.re = -32285, .im = -5602}},
    {.s = {.re = -32137, .im = -6393}},  {.s = {.re = -31971, .im = -7179}},
    {.s = {.re = -31785, .im = -7962}},  {.s = {.re = -31580, .im = -8739}},
    {.s = {.re = -31356, .im = -9512}},  {.s = {.re = -31113, .im = -10278}},
    {.s = {.re = -30852, .im = -11039}}, {.s = {.re = -30571, .im = -11793}},
    {.s = {.re = -30273, .im = -12539}}, {.s = {.re = -29956, .im = -13279}},
    {.s = {.re = -29621, .im = -14010}}, {.s = {.re = -29268, .im = -14732}},
    {.s = {.re = -28898, .im = -15446}}, {.s = {.re = -28510, .im = -16151}},
    {.s = {.re = -28105, .im = -16846}}, {.s = {.re = -27683, .im = -17530}},
    {.s = {.re = -27245, .im = -18204}}, {.s = {.re = -26790, .im = -18868}},
    {.s = {.re = -26319, .im = -19519}}, {.s = {.re = -25832, .im = -20159}},
    {.s = {.re = -25329, .im = -20787}}, {.s = {.re = -24811, .im = -21403}},
    {.s = {.re = -24279, .im = -22005}}, {.s = {.re = -23731, .im = -22594}},
    {.s = {.re = -23170, .im = -23170}}, {.s = {.re = -22594, .im = -23731}},
    {.s = {.re = -22005, .im = -24279}}, {.s = {.re = -21403, .im = -24811}},
    {.s = {.re = -20787, .im = -25329}}, {.s = {.re = -20159, .im = -25832}},
    {.s = {.re = -19519, .im = -26319}}, {.s = {.re = -18868, .im = -26790}},
    {.s = {.re = -18204, .im = -27245}}, {.s = {.re = -17530, .im = -27683}},
    {.s = {.re = -16846, .im = -28105}}, {.s = {.re = -16151, .im = -28510}},
    {.s = {.re = -15446, .im = -28898}}, {.s = {.re = -14732, .im = -29268}},
    {.s = {.re = -14010, .im = -29621}}, {.s = {.re = -13279, .im = -29956}},
    {.s = {.re = -12539, .im = -30273}}, {.s = {.re = -11793, .im = -30571}},
    {.s = {.re = -11039, .im = -30852}}, {.s = {.re = -10278, .im = -31113}},
    {.s = {.re = -9512, .im = -31356}},  {.s = {.re = -8739, .im = -31580}},
    {.s = {.re = -7962, .im = -31785}},  {.s = {.re = -7179, .im = -31971}},
    {.s = {.re = -6393, .im = -32137}},  {.s = {.re = -5602, .im = -32285}},
    {.s = {.re = -4808, .im = -32412}},  {.s = {.re = -4011, .im = -32521}},
    {.s = {.re = -3212, .im = -32609}},  {.s = {.re = -2410, .im = -32678}},
    {.s = {.re = -1608, .im = -32728}},  {.s = {.re = -804, .im = -32757}},
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -1206, .im = 32745}},
    {.s = {.re = -2410, .im = 32678}},   {.s = {.re = -3612, .im = 32567}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -5998, .im = 32213}},
    {.s = {.re = -7179, .im = 31971}},   {.s = {.re = -8351, .im = 31685}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -10659, .im = 30985}},
    {.s = {.re = -11793, .im = 30571}},  {.s = {.re = -12910, .im = 30117}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -15090, .im = 29085}},
    {.s = {.re = -16151, .im = 28510}},  {.s = {.re = -17189, .im = 27896}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -19195, .im = 26556}},
    {.s = {.re = -20159, .im = 25832}},  {.s = {.re = -21096, .im = 25072}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -22884, .im = 23452}},
    {.s = {.re = -23731, .im = 22594}},  {.s = {.re = -24547, .im = 21705}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -26077, .im = 19841}},
    {.s = {.re = -26790, .im = 18868}},  {.s = {.re = -27466, .im = 17869}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -28706, .im = 15800}},
    {.s = {.re = -29268, .im = 14732}},  {.s = {.re = -29791, .im = 13645}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30714, .im = 11417}},
    {.s = {.re = -31113, .im = 10278}},  {.s = {.re = -31470, .im = 9126}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -32057, .im = 6786}},
    {.s = {.re = -32285, .im = 5602}},   {.s = {.re = -32469, .im = 4410}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32705, .im = 2009}},
    {.s = {.re = -32757, .im = 804}},    {.s = {.re = -32765, .im = -402}},
    {.s = {.re = -32728, .im = -1608}},  {.s = {.re = -32646, .im = -2811}},
    {.s = {.re = -32521, .im = -4011}},  {.s = {.re = -32351, .im = -5205}},
    {.s = {.re = -32137, .im = -6393}},  {.s = {.re = -31880, .im = -7571}},
    {.s = {.re = -31580, .im = -8739}},  {.s = {.re = -31237, .im = -9896}},
    {.s = {.re = -30852, .im = -11039}}, {.s = {.re = -30424, .im = -12167}},
    {.s = {.re = -29956, .im = -13279}}, {.s = {.re = -29447, .im = -14372}},
    {.s = {.re = -28898, .im = -15446}}, {.s = {.re = -28310, .im = -16499}},
    {.s = {.re = -27683, .im = -17530}}, {.s = {.re = -27019, .im = -18537}},
    {.s = {.re = -26319, .im = -19519}}, {.s = {.re = -25582, .im = -20475}},
    {.s = {.re = -24811, .im = -21403}}, {.s = {.re = -24007, .im = -22301}},
    {.s = {.re = -23170, .im = -23170}}, {.s = {.re = -22301, .im = -24007}},
    {.s = {.re = -21403, .im = -24811}}, {.s = {.re = -20475, .im = -25582}},
    {.s = {.re = -19519, .im = -26319}}, {.s = {.re = -18537, .im = -27019}},
    {.s = {.re = -17530, .im = -27683}}, {.s = {.re = -16499, .im = -28310}},
    {.s = {.re = -15446, .im = -28898}}, {.s = {.re = -14372, .im = -29447}},
    {.s = {.re = -13279, .im = -29956}}, {.s = {.re = -12167, .im = -30424}},
    {.s = {.re = -11039, .im = -30852}}, {.s = {.re = -9896, .im = -31237}},
    {.s = {.re = -8739, .im = -31580}},  {.s = {.re = -7571, .im = -31880}},
    {.s = {.re = -6393, .im = -32137}},  {.s = {.re = -5205, .im = -32351}},
    {.s = {.re = -4011, .im = -32521}},  {.s = {.re = -2811, .im = -32646}},
    {.s = {.re = -1608, .im = -32728}},  {.s = {.re = -402, .im = -32765}},
    {.s = {.re = 804, .im = -32757}},    {.s = {.re = 2009, .im = -32705}},
    {.s = {.re = 3212, .im = -32609}},   {.s = {.re = 4410, .im = -32469}},
    {.s = {.re = 5602, .im = -32285}},   {.s = {.re = 6786, .im = -32057}},
    {.s = {.re = 7962, .im = -31785}},   {.s = {.re = 9126, .im = -31470}},
    {.s = {.re = 10278, .im = -31113}},  {.s = {.re = 11417, .im = -30714}},
    {.s = {.re = 12539, .im = -30273}},  {.s = {.re = 13645, .im = -29791}},
    {.s = {.re = 14732, .im = -29268}},  {.s = {.re = 15800, .im = -28706}},
    {.s = {.re = 16846, .im = -28105}},  {.s = {.re = 17869, .im = -27466}},
    {.s = {.re = 18868, .im = -26790}},  {.s = {.re = 19841, .im = -26077}},
    {.s = {.re = 20787, .im = -25329}},  {.s = {.re = 21705, .im = -24547}},
    {.s = {.re = 22594, .im = -23731}},  {.s = {.re = 23452, .im = -22884}},
    {.s = {.re = 24279, .im = -22005}},  {.s = {.re = 25072, .im = -21096}},
    {.s = {.re = 25832, .im = -20159}},  {.s = {.re = 26556, .im = -19195}},
    {.s = {.re = 27245, .im = -18204}},  {.s = {.re = 27896, .im = -17189}},
    {.s = {.re = 28510, .im = -16151}},  {.s = {.re = 29085, .im = -15090}},
    {.s = {.re = 29621, .im = -14010}},  {.s = {.re = 30117, .im = -12910}},
    {.s = {.re = 30571, .im = -11793}},  {.s = {.re = 30985, .im = -10659}},
    {.s = {.re = 31356, .im = -9512}},   {.s = {.re = 31685, .im = -8351}},
    {.s = {.re = 31971, .im = -7179}},   {.s = {.re = 32213, .im = -5998}},
    {.s = {.re = 32412, .im = -4808}},   {.s = {.re = 32567, .im = -3612}},
    {.s = {.re = 32678, .im = -2410}},   {.s = {.re = 32745, .im = -1206}},
};
#endif

#if MIN_RFFT_LEN <= 1024 && MAX_RFFT_LEN >= 1024
const complex_fract16 twiddles_1024[] = {
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -201, .im = 32766}},
    {.s = {.re = -402, .im = 32765}},    {.s = {.re = -603, .im = 32761}},
    {.s = {.re = -804, .im = 32757}},    {.s = {.re = -1005, .im = 32752}},
    {.s = {.re = -1206, .im = 32745}},   {.s = {.re = -1407, .im = 32737}},
    {.s = {.re = -1608, .im = 32728}},   {.s = {.re = -1809, .im = 32717}},
    {.s = {.re = -2009, .im = 32705}},   {.s = {.re = -2210, .im = 32692}},
    {.s = {.re = -2410, .im = 32678}},   {.s = {.re = -2611, .im = 32663}},
    {.s = {.re = -2811, .im = 32646}},   {.s = {.re = -3012, .im = 32628}},
    {.s = {.re = -3212, .im = 32609}},   {.s = {.re = -3412, .im = 32589}},
    {.s = {.re = -3612, .im = 32567}},   {.s = {.re = -3811, .im = 32545}},
    {.s = {.re = -4011, .im = 32521}},   {.s = {.re = -4210, .im = 32495}},
    {.s = {.re = -4410, .im = 32469}},   {.s = {.re = -4609, .im = 32441}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -5007, .im = 32382}},
    {.s = {.re = -5205, .im = 32351}},   {.s = {.re = -5404, .im = 32318}},
    {.s = {.re = -5602, .im = 32285}},   {.s = {.re = -5800, .im = 32250}},
    {.s = {.re = -5998, .im = 32213}},   {.s = {.re = -6195, .im = 32176}},
    {.s = {.re = -6393, .im = 32137}},   {.s = {.re = -6590, .im = 32098}},
    {.s = {.re = -6786, .im = 32057}},   {.s = {.re = -6983, .im = 32014}},
    {.s = {.re = -7179, .im = 31971}},   {.s = {.re = -7375, .im = 31926}},
    {.s = {.re = -7571, .im = 31880}},   {.s = {.re = -7767, .im = 31833}},
    {.s = {.re = -7962, .im = 31785}},   {.s = {.re = -8157, .im = 31736}},
    {.s = {.re = -8351, .im = 31685}},   {.s = {.re = -8545, .im = 31633}},
    {.s = {.re = -8739, .im = 31580}},   {.s = {.re = -8933, .im = 31526}},
    {.s = {.re = -9126, .im = 31470}},   {.s = {.re = -9319, .im = 31414}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -9704, .im = 31297}},
    {.s = {.re = -9896, .im = 31237}},   {.s = {.re = -10087, .im = 31176}},
    {.s = {.re = -10278, .im = 31113}},  {.s = {.re = -10469, .im = 31050}},
    {.s = {.re = -10659, .im = 30985}},  {.s = {.re = -10849, .im = 30919}},
    {.s = {.re = -11039, .im = 30852}},  {.s = {.re = -11228, .im = 30783}},
    {.s = {.re = -11417, .im = 30714}},  {.s = {.re = -11605, .im = 30643}},
    {.s = {.re = -11793, .im = 30571}},  {.s = {.re = -11980, .im = 30498}},
    {.s = {.re = -12167, .im = 30424}},  {.s = {.re = -12353, .im = 30349}},
    {.s = {.re = -12539, .im = 30273}},  {.s = {.re = -12725, .im = 30195}},
    {.s = {.re = -12910, .im = 30117}},  {.s = {.re = -13094, .im = 30037}},
    {.s = {.re = -13279, .im = 29956}},  {.s = {.re = -13462, .im = 29874}},
    {.s = {.re = -13645, .im = 29791}},  {.s = {.re = -13828, .im = 29706}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -14191, .im = 29534}},
    {.s = {.re = -14372, .im = 29447}},  {.s = {.re = -14553, .im = 29358}},
    {.s = {.re = -14732, .im = 29268}},  {.s = {.re = -14912, .im = 29177}},
    {.s = {.re = -15090, .im = 29085}},  {.s = {.re = -15269, .im = 28992}},
    {.s = {.re = -15446, .im = 28898}},  {.s = {.re = -15623, .im = 28803}},
    {.s = {.re = -15800, .im = 28706}},  {.s = {.re = -15976, .im = 28609}},
    {.s = {.re = -16151, .im = 28510}},  {.s = {.re = -16325, .im = 28411}},
    {.s = {.re = -16499, .im = 28310}},  {.s = {.re = -16673, .im = 28208}},
    {.s = {.re = -16846, .im = 28105}},  {.s = {.re = -17018, .im = 28001}},
    {.s = {.re = -17189, .im = 27896}},  {.s = {.re = -17360, .im = 27790}},
    {.s = {.re = -17530, .im = 27683}},  {.s = {.re = -17700, .im = 27575}},
    {.s = {.re = -17869, .im = 27466}},  {.s = {.re = -18037, .im = 27356}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -18371, .im = 27133}},
    {.s = {.re = -18537, .im = 27019}},  {.s = {.re = -18703, .im = 26905}},
    {.s = {.re = -18868, .im = 26790}},  {.s = {.re = -19032, .im = 26674}},
    {.s = {.re = -19195, .im = 26556}},  {.s = {.re = -19357, .im = 26438}},
    {.s = {.re = -19519, .im = 26319}},  {.s = {.re = -19680, .im = 26198}},
    {.s = {.re = -19841, .im = 26077}},  {.s = {.re = -20000, .im = 25955}},
    {.s = {.re = -20159, .im = 25832}},  {.s = {.re = -20317, .im = 25708}},
    {.s = {.re = -20475, .im = 25582}},  {.s = {.re = -20631, .im = 25456}},
    {.s = {.re = -20787, .im = 25329}},  {.s = {.re = -20942, .im = 25201}},
    {.s = {.re = -21096, .im = 25072}},  {.s = {.re = -21250, .im = 24942}},
    {.s = {.re = -21403, .im = 24811}},  {.s = {.re = -21554, .im = 24680}},
    {.s = {.re = -21705, .im = 24547}},  {.s = {.re = -21856, .im = 24413}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -22154, .im = 24143}},
    {.s = {.re = -22301, .im = 24007}},  {.s = {.re = -22448, .im = 23870}},
    {.s = {.re = -22594, .im = 23731}},  {.s = {.re = -22739, .im = 23592}},
    {.s = {.re = -22884, .im = 23452}},  {.s = {.re = -23027, .im = 23311}},
    {.s = {.re = -23170, .im = 23170}},  {.s = {.re = -23311, .im = 23027}},
    {.s = {.re = -23452, .im = 22884}},  {.s = {.re = -23592, .im = 22739}},
    {.s = {.re = -23731, .im = 22594}},  {.s = {.re = -23870, .im = 22448}},
    {.s = {.re = -24007, .im = 22301}},  {.s = {.re = -24143, .im = 22154}},
    {.s = {.re = -24279, .im = 22005}},  {.s = {.re = -24413, .im = 21856}},
    {.s = {.re = -24547, .im = 21705}},  {.s = {.re = -24680, .im = 21554}},
    {.s = {.re = -24811, .im = 21403}},  {.s = {.re = -24942, .im = 21250}},
    {.s = {.re = -25072, .im = 21096}},  {.s = {.re = -25201, .im = 20942}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -25456, .im = 20631}},
    {.s = {.re = -25582, .im = 20475}},  {.s = {.re = -25708, .im = 20317}},
    {.s = {.re = -25832, .im = 20159}},  {.s = {.re = -25955, .im = 20000}},
    {.s = {.re = -26077, .im = 19841}},  {.s = {.re = -26198, .im = 19680}},
    {.s = {.re = -26319, .im = 19519}},  {.s = {.re = -26438, .im = 19357}},
    {.s = {.re = -26556, .im = 19195}},  {.s = {.re = -26674, .im = 19032}},
    {.s = {.re = -26790, .im = 18868}},  {.s = {.re = -26905, .im = 18703}},
    {.s = {.re = -27019, .im = 18537}},  {.s = {.re = -27133, .im = 18371}},
    {.s = {.re = -27245, .im = 18204}},  {.s = {.re = -27356, .im = 18037}},
    {.s = {.re = -27466, .im = 17869}},  {.s = {.re = -27575, .im = 17700}},
    {.s = {.re = -27683, .im = 17530}},  {.s = {.re = -27790, .im = 17360}},
    {.s = {.re = -27896, .im = 17189}},  {.s = {.re = -28001, .im = 17018}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -28208, .im = 16673}},
    {.s = {.re = -28310, .im = 16499}},  {.s = {.re = -28411, .im = 16325}},
    {.s = {.re = -28510, .im = 16151}},  {.s = {.re = -28609, .im = 15976}},
    {.s = {.re = -28706, .im = 15800}},  {.s = {.re = -28803, .im = 15623}},
    {.s = {.re = -28898, .im = 15446}},  {.s = {.re = -28992, .im = 15269}},
    {.s = {.re = -29085, .im = 15090}},  {.s = {.re = -29177, .im = 14912}},
    {.s = {.re = -29268, .im = 14732}},  {.s = {.re = -29358, .im = 14553}},
    {.s = {.re = -29447, .im = 14372}},  {.s = {.re = -29534, .im = 14191}},
    {.s = {.re = -29621, .im = 14010}},  {.s = {.re = -29706, .im = 13828}},
    {.s = {.re = -29791, .im = 13645}},  {.s = {.re = -29874, .im = 13462}},
    {.s = {.re = -29956, .im = 13279}},  {.s = {.re = -30037, .im = 13094}},
    {.s = {.re = -30117, .im = 12910}},  {.s = {.re = -30195, .im = 12725}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30349, .im = 12353}},
    {.s = {.re = -30424, .im = 12167}},  {.s = {.re = -30498, .im = 11980}},
    {.s = {.re = -30571, .im = 11793}},  {.s = {.re = -30643, .im = 11605}},
    {.s = {.re = -30714, .im = 11417}},  {.s = {.re = -30783, .im = 11228}},
    {.s = {.re = -30852, .im = 11039}},  {.s = {.re = -30919, .im = 10849}},
    {.s = {.re = -30985, .im = 10659}},  {.s = {.re = -31050, .im = 10469}},
    {.s = {.re = -31113, .im = 10278}},  {.s = {.re = -31176, .im = 10087}},
    {.s = {.re = -31237, .im = 9896}},   {.s = {.re = -31297, .im = 9704}},
    {.s = {.re = -31356, .im = 9512}},   {.s = {.re = -31414, .im = 9319}},
    {.s = {.re = -31470, .im = 9126}},   {.s = {.re = -31526, .im = 8933}},
    {.s = {.re = -31580, .im = 8739}},   {.s = {.re = -31633, .im = 8545}},
    {.s = {.re = -31685, .im = 8351}},   {.s = {.re = -31736, .im = 8157}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -31833, .im = 7767}},
    {.s = {.re = -31880, .im = 7571}},   {.s = {.re = -31926, .im = 7375}},
    {.s = {.re = -31971, .im = 7179}},   {.s = {.re = -32014, .im = 6983}},
    {.s = {.re = -32057, .im = 6786}},   {.s = {.re = -32098, .im = 6590}},
    {.s = {.re = -32137, .im = 6393}},   {.s = {.re = -32176, .im = 6195}},
    {.s = {.re = -32213, .im = 5998}},   {.s = {.re = -32250, .im = 5800}},
    {.s = {.re = -32285, .im = 5602}},   {.s = {.re = -32318, .im = 5404}},
    {.s = {.re = -32351, .im = 5205}},   {.s = {.re = -32382, .im = 5007}},
    {.s = {.re = -32412, .im = 4808}},   {.s = {.re = -32441, .im = 4609}},
    {.s = {.re = -32469, .im = 4410}},   {.s = {.re = -32495, .im = 4210}},
    {.s = {.re = -32521, .im = 4011}},   {.s = {.re = -32545, .im = 3811}},
    {.s = {.re = -32567, .im = 3612}},   {.s = {.re = -32589, .im = 3412}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32628, .im = 3012}},
    {.s = {.re = -32646, .im = 2811}},   {.s = {.re = -32663, .im = 2611}},
    {.s = {.re = -32678, .im = 2410}},   {.s = {.re = -32692, .im = 2210}},
    {.s = {.re = -32705, .im = 2009}},   {.s = {.re = -32717, .im = 1809}},
    {.s = {.re = -32728, .im = 1608}},   {.s = {.re = -32737, .im = 1407}},
    {.s = {.re = -32745, .im = 1206}},   {.s = {.re = -32752, .im = 1005}},
    {.s = {.re = -32757, .im = 804}},    {.s = {.re = -32761, .im = 603}},
    {.s = {.re = -32765, .im = 402}},    {.s = {.re = -32766, .im = 201}},
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -402, .im = 32765}},
    {.s = {.re = -804, .im = 32757}},    {.s = {.re = -1206, .im = 32745}},
    {.s = {.re = -1608, .im = 32728}},   {.s = {.re = -2009, .im = 32705}},
    {.s = {.re = -2410, .im = 32678}},   {.s = {.re = -2811, .im = 32646}},
    {.s = {.re = -3212, .im = 32609}},   {.s = {.re = -3612, .im = 32567}},
    {.s = {.re = -4011, .im = 32521}},   {.s = {.re = -4410, .im = 32469}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -5205, .im = 32351}},
    {.s = {.re = -5602, .im = 32285}},   {.s = {.re = -5998, .im = 32213}},
    {.s = {.re = -6393, .im = 32137}},   {.s = {.re = -6786, .im = 32057}},
    {.s = {.re = -7179, .im = 31971}},   {.s = {.re = -7571, .im = 31880}},
    {.s = {.re = -7962, .im = 31785}},   {.s = {.re = -8351, .im = 31685}},
    {.s = {.re = -8739, .im = 31580}},   {.s = {.re = -9126, .im = 31470}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -9896, .im = 31237}},
    {.s = {.re = -10278, .im = 31113}},  {.s = {.re = -10659, .im = 30985}},
    {.s = {.re = -11039, .im = 30852}},  {.s = {.re = -11417, .im = 30714}},
    {.s = {.re = -11793, .im = 30571}},  {.s = {.re = -12167, .im = 30424}},
    {.s = {.re = -12539, .im = 30273}},  {.s = {.re = -12910, .im = 30117}},
    {.s = {.re = -13279, .im = 29956}},  {.s = {.re = -13645, .im = 29791}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -14372, .im = 29447}},
    {.s = {.re = -14732, .im = 29268}},  {.s = {.re = -15090, .im = 29085}},
    {.s = {.re = -15446, .im = 28898}},  {.s = {.re = -15800, .im = 28706}},
    {.s = {.re = -16151, .im = 28510}},  {.s = {.re = -16499, .im = 28310}},
    {.s = {.re = -16846, .im = 28105}},  {.s = {.re = -17189, .im = 27896}},
    {.s = {.re = -17530, .im = 27683}},  {.s = {.re = -17869, .im = 27466}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -18537, .im = 27019}},
    {.s = {.re = -18868, .im = 26790}},  {.s = {.re = -19195, .im = 26556}},
    {.s = {.re = -19519, .im = 26319}},  {.s = {.re = -19841, .im = 26077}},
    {.s = {.re = -20159, .im = 25832}},  {.s = {.re = -20475, .im = 25582}},
    {.s = {.re = -20787, .im = 25329}},  {.s = {.re = -21096, .im = 25072}},
    {.s = {.re = -21403, .im = 24811}},  {.s = {.re = -21705, .im = 24547}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -22301, .im = 24007}},
    {.s = {.re = -22594, .im = 23731}},  {.s = {.re = -22884, .im = 23452}},
    {.s = {.re = -23170, .im = 23170}},  {.s = {.re = -23452, .im = 22884}},
    {.s = {.re = -23731, .im = 22594}},  {.s = {.re = -24007, .im = 22301}},
    {.s = {.re = -24279, .im = 22005}},  {.s = {.re = -24547, .im = 21705}},
    {.s = {.re = -24811, .im = 21403}},  {.s = {.re = -25072, .im = 21096}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -25582, .im = 20475}},
    {.s = {.re = -25832, .im = 20159}},  {.s = {.re = -26077, .im = 19841}},
    {.s = {.re = -26319, .im = 19519}},  {.s = {.re = -26556, .im = 19195}},
    {.s = {.re = -26790, .im = 18868}},  {.s = {.re = -27019, .im = 18537}},
    {.s = {.re = -27245, .im = 18204}},  {.s = {.re = -27466, .im = 17869}},
    {.s = {.re = -27683, .im = 17530}},  {.s = {.re = -27896, .im = 17189}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -28310, .im = 16499}},
    {.s = {.re = -28510, .im = 16151}},  {.s = {.re = -28706, .im = 15800}},
    {.s = {.re = -28898, .im = 15446}},  {.s = {.re = -29085, .im = 15090}},
    {.s = {.re = -29268, .im = 14732}},  {.s = {.re = -29447, .im = 14372}},
    {.s = {.re = -29621, .im = 14010}},  {.s = {.re = -29791, .im = 13645}},
    {.s = {.re = -29956, .im = 13279}},  {.s = {.re = -30117, .im = 12910}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30424, .im = 12167}},
    {.s = {.re = -30571, .im = 11793}},  {.s = {.re = -30714, .im = 11417}},
    {.s = {.re = -30852, .im = 11039}},  {.s = {.re = -30985, .im = 10659}},
    {.s = {.re = -31113, .im = 10278}},  {.s = {.re = -31237, .im = 9896}},
    {.s = {.re = -31356, .im = 9512}},   {.s = {.re = -31470, .im = 9126}},
    {.s = {.re = -31580, .im = 8739}},   {.s = {.re = -31685, .im = 8351}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -31880, .im = 7571}},
    {.s = {.re = -31971, .im = 7179}},   {.s = {.re = -32057, .im = 6786}},
    {.s = {.re = -32137, .im = 6393}},   {.s = {.re = -32213, .im = 5998}},
    {.s = {.re = -32285, .im = 5602}},   {.s = {.re = -32351, .im = 5205}},
    {.s = {.re = -32412, .im = 4808}},   {.s = {.re = -32469, .im = 4410}},
    {.s = {.re = -32521, .im = 4011}},   {.s = {.re = -32567, .im = 3612}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32646, .im = 2811}},
    {.s = {.re = -32678, .im = 2410}},   {.s = {.re = -32705, .im = 2009}},
    {.s = {.re = -32728, .im = 1608}},   {.s = {.re = -32745, .im = 1206}},
    {.s = {.re = -32757, .im = 804}},    {.s = {.re = -32765, .im = 402}},
    {.s = {.re = -32767, .im = 0}},      {.s = {.re = -32765, .im = -402}},
    {.s = {.re = -32757, .im = -804}},   {.s = {.re = -32745, .im = -1206}},
    {.s = {.re = -32728, .im = -1608}},  {.s = {.re = -32705, .im = -2009}},
    {.s = {.re = -32678, .im = -2410}},  {.s = {.re = -32646, .im = -2811}},
    {.s = {.re = -32609, .im = -3212}},  {.s = {.re = -32567, .im = -3612}},
    {.s = {.re = -32521, .im = -4011}},  {.s = {.re = -32469, .im = -4410}},
    {.s = {.re = -32412, .im = -4808}},  {.s = {.re = -32351, .im = -5205}},
    {.s = {.re = -32285, .im = -5602}},  {.s = {.re = -32213, .im = -5998}},
    {.s = {.re = -32137, .im = -6393}},  {.s = {.re = -32057, .im = -6786}},
    {.s = {.re = -31971, .im = -7179}},  {.s = {.re = -31880, .im = -7571}},
    {.s = {.re = -31785, .im = -7962}},  {.s = {.re = -31685, .im = -8351}},
    {.s = {.re = -31580, .im = -8739}},  {.s = {.re = -31470, .im = -9126}},
    {.s = {.re = -31356, .im = -9512}},  {.s = {.re = -31237, .im = -9896}},
    {.s = {.re = -31113, .im = -10278}}, {.s = {.re = -30985, .im = -10659}},
    {.s = {.re = -30852, .im = -11039}}, {.s = {.re = -30714, .im = -11417}},
    {.s = {.re = -30571, .im = -11793}}, {.s = {.re = -30424, .im = -12167}},
    {.s = {.re = -30273, .im = -12539}}, {.s = {.re = -30117, .im = -12910}},
    {.s = {.re = -29956, .im = -13279}}, {.s = {.re = -29791, .im = -13645}},
    {.s = {.re = -29621, .im = -14010}}, {.s = {.re = -29447, .im = -14372}},
    {.s = {.re = -29268, .im = -14732}}, {.s = {.re = -29085, .im = -15090}},
    {.s = {.re = -28898, .im = -15446}}, {.s = {.re = -28706, .im = -15800}},
    {.s = {.re = -28510, .im = -16151}}, {.s = {.re = -28310, .im = -16499}},
    {.s = {.re = -28105, .im = -16846}}, {.s = {.re = -27896, .im = -17189}},
    {.s = {.re = -27683, .im = -17530}}, {.s = {.re = -27466, .im = -17869}},
    {.s = {.re = -27245, .im = -18204}}, {.s = {.re = -27019, .im = -18537}},
    {.s = {.re = -26790, .im = -18868}}, {.s = {.re = -26556, .im = -19195}},
    {.s = {.re = -26319, .im = -19519}}, {.s = {.re = -26077, .im = -19841}},
    {.s = {.re = -25832, .im = -20159}}, {.s = {.re = -25582, .im = -20475}},
    {.s = {.re = -25329, .im = -20787}}, {.s = {.re = -25072, .im = -21096}},
    {.s = {.re = -24811, .im = -21403}}, {.s = {.re = -24547, .im = -21705}},
    {.s = {.re = -24279, .im = -22005}}, {.s = {.re = -24007, .im = -22301}},
    {.s = {.re = -23731, .im = -22594}}, {.s = {.re = -23452, .im = -22884}},
    {.s = {.re = -23170, .im = -23170}}, {.s = {.re = -22884, .im = -23452}},
    {.s = {.re = -22594, .im = -23731}}, {.s = {.re = -22301, .im = -24007}},
    {.s = {.re = -22005, .im = -24279}}, {.s = {.re = -21705, .im = -24547}},
    {.s = {.re = -21403, .im = -24811}}, {.s = {.re = -21096, .im = -25072}},
    {.s = {.re = -20787, .im = -25329}}, {.s = {.re = -20475, .im = -25582}},
    {.s = {.re = -20159, .im = -25832}}, {.s = {.re = -19841, .im = -26077}},
    {.s = {.re = -19519, .im = -26319}}, {.s = {.re = -19195, .im = -26556}},
    {.s = {.re = -18868, .im = -26790}}, {.s = {.re = -18537, .im = -27019}},
    {.s = {.re = -18204, .im = -27245}}, {.s = {.re = -17869, .im = -27466}},
    {.s = {.re = -17530, .im = -27683}}, {.s = {.re = -17189, .im = -27896}},
    {.s = {.re = -16846, .im = -28105}}, {.s = {.re = -16499, .im = -28310}},
    {.s = {.re = -16151, .im = -28510}}, {.s = {.re = -15800, .im = -28706}},
    {.s = {.re = -15446, .im = -28898}}, {.s = {.re = -15090, .im = -29085}},
    {.s = {.re = -14732, .im = -29268}}, {.s = {.re = -14372, .im = -29447}},
    {.s = {.re = -14010, .im = -29621}}, {.s = {.re = -13645, .im = -29791}},
    {.s = {.re = -13279, .im = -29956}}, {.s = {.re = -12910, .im = -30117}},
    {.s = {.re = -12539, .im = -30273}}, {.s = {.re = -12167, .im = -30424}},
    {.s = {.re = -11793, .im = -30571}}, {.s = {.re = -11417, .im = -30714}},
    {.s = {.re = -11039, .im = -30852}}, {.s = {.re = -10659, .im = -30985}},
    {.s = {.re = -10278, .im = -31113}}, {.s = {.re = -9896, .im = -31237}},
    {.s = {.re = -9512, .im = -31356}},  {.s = {.re = -9126, .im = -31470}},
    {.s = {.re = -8739, .im = -31580}},  {.s = {.re = -8351, .im = -31685}},
    {.s = {.re = -7962, .im = -31785}},  {.s = {.re = -7571, .im = -31880}},
    {.s = {.re = -7179, .im = -31971}},  {.s = {.re = -6786, .im = -32057}},
    {.s = {.re = -6393, .im = -32137}},  {.s = {.re = -5998, .im = -32213}},
    {.s = {.re = -5602, .im = -32285}},  {.s = {.re = -5205, .im = -32351}},
    {.s = {.re = -4808, .im = -32412}},  {.s = {.re = -4410, .im = -32469}},
    {.s = {.re = -4011, .im = -32521}},  {.s = {.re = -3612, .im = -32567}},
    {.s = {.re = -3212, .im = -32609}},  {.s = {.re = -2811, .im = -32646}},
    {.s = {.re = -2410, .im = -32678}},  {.s = {.re = -2009, .im = -32705}},
    {.s = {.re = -1608, .im = -32728}},  {.s = {.re = -1206, .im = -32745}},
    {.s = {.re = -804, .im = -32757}},   {.s = {.re = -402, .im = -32765}},
    {.s = {.re = 0, .im = 32767}},       {.s = {.re = -603, .im = 32761}},
    {.s = {.re = -1206, .im = 32745}},   {.s = {.re = -1809, .im = 32717}},
    {.s = {.re = -2410, .im = 32678}},   {.s = {.re = -3012, .im = 32628}},
    {.s = {.re = -3612, .im = 32567}},   {.s = {.re = -4210, .im = 32495}},
    {.s = {.re = -4808, .im = 32412}},   {.s = {.re = -5404, .im = 32318}},
    {.s = {.re = -5998, .im = 32213}},   {.s = {.re = -6590, .im = 32098}},
    {.s = {.re = -7179, .im = 31971}},   {.s = {.re = -7767, .im = 31833}},
    {.s = {.re = -8351, .im = 31685}},   {.s = {.re = -8933, .im = 31526}},
    {.s = {.re = -9512, .im = 31356}},   {.s = {.re = -10087, .im = 31176}},
    {.s = {.re = -10659, .im = 30985}},  {.s = {.re = -11228, .im = 30783}},
    {.s = {.re = -11793, .im = 30571}},  {.s = {.re = -12353, .im = 30349}},
    {.s = {.re = -12910, .im = 30117}},  {.s = {.re = -13462, .im = 29874}},
    {.s = {.re = -14010, .im = 29621}},  {.s = {.re = -14553, .im = 29358}},
    {.s = {.re = -15090, .im = 29085}},  {.s = {.re = -15623, .im = 28803}},
    {.s = {.re = -16151, .im = 28510}},  {.s = {.re = -16673, .im = 28208}},
    {.s = {.re = -17189, .im = 27896}},  {.s = {.re = -17700, .im = 27575}},
    {.s = {.re = -18204, .im = 27245}},  {.s = {.re = -18703, .im = 26905}},
    {.s = {.re = -19195, .im = 26556}},  {.s = {.re = -19680, .im = 26198}},
    {.s = {.re = -20159, .im = 25832}},  {.s = {.re = -20631, .im = 25456}},
    {.s = {.re = -21096, .im = 25072}},  {.s = {.re = -21554, .im = 24680}},
    {.s = {.re = -22005, .im = 24279}},  {.s = {.re = -22448, .im = 23870}},
    {.s = {.re = -22884, .im = 23452}},  {.s = {.re = -23311, .im = 23027}},
    {.s = {.re = -23731, .im = 22594}},  {.s = {.re = -24143, .im = 22154}},
    {.s = {.re = -24547, .im = 21705}},  {.s = {.re = -24942, .im = 21250}},
    {.s = {.re = -25329, .im = 20787}},  {.s = {.re = -25708, .im = 20317}},
    {.s = {.re = -26077, .im = 19841}},  {.s = {.re = -26438, .im = 19357}},
    {.s = {.re = -26790, .im = 18868}},  {.s = {.re = -27133, .im = 18371}},
    {.s = {.re = -27466, .im = 17869}},  {.s = {.re = -27790, .im = 17360}},
    {.s = {.re = -28105, .im = 16846}},  {.s = {.re = -28411, .im = 16325}},
    {.s = {.re = -28706, .im = 15800}},  {.s = {.re = -28992, .im = 15269}},
    {.s = {.re = -29268, .im = 14732}},  {.s = {.re = -29534, .im = 14191}},
    {.s = {.re = -29791, .im = 13645}},  {.s = {.re = -30037, .im = 13094}},
    {.s = {.re = -30273, .im = 12539}},  {.s = {.re = -30498, .im = 11980}},
    {.s = {.re = -30714, .im = 11417}},  {.s = {.re = -30919, .im = 10849}},
    {.s = {.re = -31113, .im = 10278}},  {.s = {.re = -31297, .im = 9704}},
    {.s = {.re = -31470, .im = 9126}},   {.s = {.re = -31633, .im = 8545}},
    {.s = {.re = -31785, .im = 7962}},   {.s = {.re = -31926, .im = 7375}},
    {.s = {.re = -32057, .im = 6786}},   {.s = {.re = -32176, .im = 6195}},
    {.s = {.re = -32285, .im = 5602}},   {.s = {.re = -32382, .im = 5007}},
    {.s = {.re = -32469, .im = 4410}},   {.s = {.re = -32545, .im = 3811}},
    {.s = {.re = -32609, .im = 3212}},   {.s = {.re = -32663, .im = 2611}},
    {.s = {.re = -32705, .im = 2009}},   {.s = {.re = -32737, .im = 1407}},
    {.s = {.re = -32757, .im = 804}},    {.s = {.re = -32766, .im = 201}},
    {.s = {.re = -32765, .im = -402}},   {.s = {.re = -32752, .im = -1005}},
    {.s = {.re = -32728, .im = -1608}},  {.s = {.re = -32692, .im = -2210}},
    {.s = {.re = -32646, .im = -2811}},  {.s = {.re = -32589, .im = -3412}},
    {.s = {.re = -32521, .im = -4011}},  {.s = {.re = -32441, .im = -4609}},
    {.s = {.re = -32351, .im = -5205}},  {.s = {.re = -32250, .im = -5800}},
    {.s = {.re = -32137, .im = -6393}},  {.s = {.re = -32014, .im = -6983}},
    {.s = {.re = -31880, .im = -7571}},  {.s = {.re = -31736, .im = -8157}},
    {.s = {.re = -31580, .im = -8739}},  {.s = {.re = -31414, .im = -9319}},
    {.s = {.re = -31237, .im = -9896}},  {.s = {.re = -31050, .im = -10469}},
    {.s = {.re = -30852, .im = -11039}}, {.s = {.re = -30643, .im = -11605}},
    {.s = {.re = -30424, .im = -12167}}, {.s = {.re = -30195, .im = -12725}},
    {.s = {.re = -29956, .im = -13279}}, {.s = {.re = -29706, .im = -13828}},
    {.s = {.re = -29447, .im = -14372}}, {.s = {.re = -29177, .im = -14912}},
    {.s = {.re = -28898, .im = -15446}}, {.s = {.re = -28609, .im = -15976}},
    {.s = {.re = -28310, .im = -16499}}, {.s = {.re = -28001, .im = -17018}},
    {.s = {.re = -27683, .im = -17530}}, {.s = {.re = -27356, .im = -18037}},
    {.s = {.re = -27019, .im = -18537}}, {.s = {.re = -26674, .im = -19032}},
    {.s = {.re = -26319, .im = -19519}}, {.s = {.re = -25955, .im = -20000}},
    {.s = {.re = -25582, .im = -20475}}, {.s = {.re = -25201, .im = -20942}},
    {.s = {.re = -24811, .im = -21403}}, {.s = {.re = -24413, .im = -21856}},
    {.s = {.re = -24007, .im = -22301}}, {.s = {.re = -23592, .im = -22739}},
    {.s = {.re = -23170, .im = -23170}}, {.s = {.re = -22739, .im = -23592}},
    {.s = {.re = -22301, .im = -24007}}, {.s = {.re = -21856, .im = -24413}},
    {.s = {.re = -21403, .im = -24811}}, {.s = {.re = -20942, .im = -25201}},
    {.s = {.re = -20475, .im = -25582}}, {.s = {.re = -20000, .im = -25955}},
    {.s = {.re = -19519, .im = -26319}}, {.s = {.re = -19032, .im = -26674}},
    {.s = {.re = -18537, .im = -27019}}, {.s = {.re = -18037, .im = -27356}},
    {.s = {.re = -17530, .im = -27683}}, {.s = {.re = -17018, .im = -28001}},
    {.s = {.re = -16499, .im = -28310}}, {.s = {.re = -15976, .im = -28609}},
    {.s = {.re = -15446, .im = -28898}}, {.s = {.re = -14912, .im = -29177}},
    {.s = {.re = -14372, .im = -29447}}, {.s = {.re = -13828, .im = -29706}},
    {.s = {.re = -13279, .im = -29956}}, {.s = {.re = -12725, .im = -30195}},
    {.s = {.re = -12167, .im = -30424}}, {.s = {.re = -11605, .im = -30643}},
    {.s = {.re = -11039, .im = -30852}}, {.s = {.re = -10469, .im = -31050}},
    {.s = {.re = -9896, .im = -31237}},  {.s = {.re = -9319, .im = -31414}},
    {.s = {.re = -8739, .im = -31580}},  {.s = {.re = -8157, .im = -31736}},
    {.s = {.re = -7571, .im = -31880}},  {.s = {.re = -6983, .im = -32014}},
    {.s = {.re = -6393, .im = -32137}},  {.s = {.re = -5800, .im = -32250}},
    {.s = {.re = -5205, .im = -32351}},  {.s = {.re = -4609, .im = -32441}},
    {.s = {.re = -4011, .im = -32521}},  {.s = {.re = -3412, .im = -32589}},
    {.s = {.re = -2811, .im = -32646}},  {.s = {.re = -2210, .im = -32692}},
    {.s = {.re = -1608, .im = -32728}},  {.s = {.re = -1005, .im = -32752}},
    {.s = {.re = -402, .im = -32765}},   {.s = {.re = 201, .im = -32766}},
    {.s = {.re = 804, .im = -32757}},    {.s = {.re = 1407, .im = -32737}},
    {.s = {.re = 2009, .im = -32705}},   {.s = {.re = 2611, .im = -32663}},
    {.s = {.re = 3212, .im = -32609}},   {.s = {.re = 3811, .im = -32545}},
    {.s = {.re = 4410, .im = -32469}},   {.s = {.re = 5007, .im = -32382}},
    {.s = {.re = 5602, .im = -32285}},   {.s = {.re = 6195, .im = -32176}},
    {.s = {.re = 6786, .im = -32057}},   {.s = {.re = 7375, .im = -31926}},
    {.s = {.re = 7962, .im = -31785}},   {.s = {.re = 8545, .im = -31633}},
    {.s = {.re = 9126, .im = -31470}},   {.s = {.re = 9704, .im = -31297}},
    {.s = {.re = 10278, .im = -31113}},  {.s = {.re = 10849, .im = -30919}},
    {.s = {.re = 11417, .im = -30714}},  {.s = {.re = 11980, .im = -30498}},
    {.s = {.re = 12539, .im = -30273}},  {.s = {.re = 13094, .im = -30037}},
    {.s = {.re = 13645, .im = -29791}},  {.s = {.re = 14191, .im = -29534}},
    {.s = {.re = 14732, .im = -29268}},  {.s = {.re = 15269, .im = -28992}},
    {.s = {.re = 15800, .im = -28706}},  {.s = {.re = 16325, .im = -28411}},
    {.s = {.re = 16846, .im = -28105}},  {.s = {.re = 17360, .im = -27790}},
    {.s = {.re = 17869, .im = -27466}},  {.s = {.re = 18371, .im = -27133}},
    {.s = {.re = 18868, .im = -26790}},  {.s = {.re = 19357, .im = -26438}},
    {.s = {.re = 19841, .im = -26077}},  {.s = {.re = 20317, .im = -25708}},
    {.s = {.re = 20787, .im = -25329}},  {.s = {.re = 21250, .im = -24942}},
    {.s = {.re = 21705, .im = -24547}},  {.s = {.re = 22154, .im = -24143}},
    {.s = {.re = 22594, .im = -23731}},  {.s = {.re = 23027, .im = -23311}},
    {.s = {.re = 23452, .im = -22884}},  {.s = {.re = 23870, .im = -22448}},
    {.s = {.re = 24279, .im = -22005}},  {.s = {.re = 24680, .im = -21554}},
    {.s = {.re = 25072, .im = -21096}},  {.s = {.re = 25456, .im = -20631}},
    {.s = {.re = 25832, .im = -20159}},  {.s = {.re = 26198, .im = -19680}},
    {.s = {.re = 26556, .im = -19195}},  {.s = {.re = 26905, .im = -18703}},
    {.s = {.re = 27245, .im = -18204}},  {.s = {.re = 27575, .im = -17700}},
    {.s = {.re = 27896, .im = -17189}},  {.s = {.re = 28208, .im = -16673}},
    {.s = {.re = 28510, .im = -16151}},  {.s = {.re = 28803, .im = -15623}},
    {.s = {.re = 29085, .im = -15090}},  {.s = {.re = 29358, .im = -14553}},
    {.s = {.re = 29621, .im = -14010}},  {.s = {.re = 29874, .im = -13462}},
    {.s = {.re = 30117, .im = -12910}},  {.s = {.re = 30349, .im = -12353}},
    {.s = {.re = 30571, .im = -11793}},  {.s = {.re = 30783, .im = -11228}},
    {.s = {.re = 30985, .im = -10659}},  {.s = {.re = 31176, .im = -10087}},
    {.s = {.re = 31356, .im = -9512}},   {.s = {.re = 31526, .im = -8933}},
    {.s = {.re = 31685, .im = -8351}},   {.s = {.re = 31833, .im = -7767}},
    {.s = {.re = 31971, .im = -7179}},   {.s = {.re = 32098, .im = -6590}},
    {.s = {.re = 32213, .im = -5998}},   {.s = {.re = 32318, .im = -5404}},
    {.s = {.re = 32412, .im = -4808}},   {.s = {.re = 32495, .im = -4210}},
    {.s = {.re = 32567, .im = -3612}},   {.s = {.re = 32628, .im = -3012}},
    {.s = {.re = 32678, .im = -2410}},   {.s = {.re = 32717, .im = -1809}},
    {.s = {.re = 32745, .im = -1206}},   {.s = {.re = 32761, .im = -603}},
};
#endif

#endif

size_t RfftInt16GetNeededMemory(int32_t fft_length) {
#if XCHAL_HAVE_HIFI3 || XCHAL_HAVE_HIFI4 || XCHAL_HAVE_HIFI5
  return sizeof(RfftState);
#else
  size_t state_size = 0;
  kiss_fft_fixed16::kiss_fftr_alloc(fft_length, 0, nullptr, &state_size);
  return state_size;
#endif
}

void* RfftInt16Init(int32_t fft_length, void* state, size_t state_size) {
#if XCHAL_HAVE_HIFI3 || XCHAL_HAVE_HIFI4 || XCHAL_HAVE_HIFI5
  RfftState* rfft_state = (RfftState*)state;

#if defined XTENSA_NDSP_FFT_MEM_OPTIMIZED
  switch (fft_length) {
#if MIN_RFFT_LEN <= 256 && MAX_RFFT_LEN >= 256
    case 256:
      rfft_state->handle = twiddles_256;
      rfft_state->fft_length_log2 = 8;
      rfft_state->fft_length = 256;
      rfft_state->output_length = (256 / 2) + 1;
      break;
#endif
#if MIN_RFFT_LEN <= 512 && MAX_RFFT_LEN >= 512
    case 512:
      rfft_state->handle = twiddles_512;
      rfft_state->fft_length_log2 = 9;
      rfft_state->fft_length = 512;
      rfft_state->output_length = (512 / 2) + 1;
      break;
#endif
#if MIN_RFFT_LEN <= 1024 && MAX_RFFT_LEN >= 1024
    case 1024:
      rfft_state->handle = twiddles_1024;
      rfft_state->fft_length_log2 = 10;
      rfft_state->fft_length = 1024;
      rfft_state->output_size = (1024 / 2) + 1;
      break;
#endif
    default:
      return nullptr;
  }
#else
  switch (fft_length) {
#if MIN_RFFT_LEN <= 32 && MAX_RFFT_LEN >= 32
    case 32:
      rfft_state->handle = rfft16_32;
      break;
#endif
#if MIN_RFFT_LEN <= 64 && MAX_RFFT_LEN >= 64
    case 64:
      rfft_state->handle = rfft16_64;
      break;
#endif
#if MIN_RFFT_LEN <= 128 && MAX_RFFT_LEN >= 128
    case 128:
      rfft_state->handle = rfft16_128;
      break;
#endif
#if MIN_RFFT_LEN <= 256 && MAX_RFFT_LEN >= 256
    case 256:
      rfft_state->handle = rfft16_256;
      break;
#endif
#if MIN_RFFT_LEN <= 512 && MAX_RFFT_LEN >= 512
    case 512:
      rfft_state->handle = rfft16_512;
      break;
#endif
#if MIN_RFFT_LEN <= 1024 && MAX_RFFT_LEN >= 1024
    case 1024:
      rfft_state->handle = rfft16_1024;
      break;
#endif
#if MIN_RFFT_LEN <= 2048 && MAX_RFFT_LEN >= 2048
    case 2048:
      rfft_state->handle = rfft16_2048;
      break;
#endif
#if MIN_RFFT_LEN <= 4096 && MAX_RFFT_LEN >= 4096
    case 4096:
      rfft_state->handle = rfft16_4096;
      break;
#endif
#if MIN_RFFT_LEN <= 8192 && MAX_RFFT_LEN >= 8192
    case 8192:
      rfft_state->handle = rfft16_8192;
      break;
#endif
    default:
      return nullptr;
  }
#endif

  return state;
#else
  return kiss_fft_fixed16::kiss_fftr_alloc(fft_length, 0, state, &state_size);
#endif
}

void RfftInt16Apply(void* state, const int16_t* input,
                    Complex<int16_t>* output) {
#if XCHAL_HAVE_HIFI3 || XCHAL_HAVE_HIFI4 || XCHAL_HAVE_HIFI5
  RfftState* rfft_state = (RfftState*)state;

#if defined XTENSA_NDSP_FFT_MEM_OPTIMIZED
  int shifts = fft_real16x16_ie((complex_fract16*)output, (int16_t*)input,
                                (const complex_fract16*)rfft_state->handle, 1,
                                rfft_state->fft_length, 2);

  if (shifts < rfft_state->fft_length_log2) {
    for (int i = 0; i < rfft_state->output_length; i++) {
      output[i].real >>= (rfft_state->fft_length_log2 - shifts);
      output[i].imag >>= (rfft_state->fft_length_log2 - shifts);
    }
  } else if (shifts > rfft_state->fft_length_log2) {
    for (int i = 0; i < rfft_state->output_length; i++) {
      output[i].real <<= (shifts - rfft_state->fft_length_log2);
      output[i].imag <<= (shifts - rfft_state->fft_length_log2);
    }
  }
#else
  fft_real16x16((int16_t*)output, (int16_t*)input, rfft_state->handle, 3);
#endif
#else
  kiss_fft_fixed16::kiss_fftr(
      static_cast<kiss_fft_fixed16::kiss_fftr_cfg>(state),
      reinterpret_cast<const kiss_fft_scalar*>(input),
      reinterpret_cast<kiss_fft_fixed16::kiss_fft_cpx*>(output));
#endif
}

}  // namespace tflm_signal
