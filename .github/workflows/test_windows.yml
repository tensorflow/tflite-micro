name: Test - Windows

on:
  workflow_call:
    inputs:
      trigger-sha:
        required: true
        type: string

jobs:
  bazel:
    runs-on: windows-latest
    timeout-minutes: 60
    name: Windows Bazel
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.trigger-sha }}
      - name: Enable symlinks
        run: git config core.symlinks true
      - uses: bazel-contrib/setup-bazel@0.18.0
        with:
          bazelisk-cache: true
          disk-cache: true
          repository-cache: true
          bazelrc: |
            startup --windows_enable_symlinks
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Select C++ Tests
        shell: bash
        run: |
          # 1. Base: Include everything. 
          # We KEEP the wildcard because it prevents the "Incompatible Target" crash.
          echo "//tensorflow/lite/micro/..." > test_patterns.txt

          # 2. Exclude non-C++ tests (e.g. py_test, sh_test).
          # Logic: "Find all tests, subtract the cc_tests, and exclude the remainder."
          bazel query -k '
            let scope = //tensorflow/lite/micro/... in
            tests($scope) except kind(cc_test, $scope)
          ' 2>/dev/null | sed 's/^/-/' >> test_patterns.txt || true

          # 3. Exclude C++ tests that depend on Python (binary, or lib).
          bazel query -k '
            let scope = //tensorflow/lite/micro/... in
            kind(cc_test, rdeps($scope, kind("py_(binary|library)", deps($scope))))
          ' 2>/dev/null | sed 's/^/-/' >> test_patterns.txt || true
      - name: Test
        shell: bash
        run: |
          bazel --output_user_root="C:/tmp" --windows_enable_symlinks test --config=windows_ci --target_pattern_file=test_patterns.txt

  makefile:
    runs-on: windows-latest
    timeout-minutes: 60
    name: Windows Makefile
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.trigger-sha }}
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            make
            patch
            mingw-w64-x86_64-gcc
            git
            python3
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-pillow
            mingw-w64-x86_64-python-numpy
            mingw-w64-x86_64-python-absl-py
            openssl
            tar
            unzip
            curl
      - name: Test
        shell: msys2 {0}
        run: |
          tensorflow/lite/micro/tools/ci_build/test_x86_default.sh ./